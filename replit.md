# AdvisorIA - Replit Agent Guide

## Overview
AdvisorIA is a premium AI consultancy platform offering expert advice through cognitive clones of 18 specialists across 15 disciplines. It leverages the "Framework EXTRACT de 12 Camadas" (now 20 points) with Anthropic's Claude to create ultra-realistic AI personalities. The platform features a React/TypeScript frontend, an Express.js proxy, and a Python/FastAPI backend with asynchronous AI integration, aiming to provide a specialized multi-category consulting experience. The platform's ambition is to consolidate 450+ years of marketing expertise into an accessible, interactive format, providing specialized, multi-category consulting.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### Frontend
- **Framework & Tooling**: React 18 with TypeScript, Vite, Wouter for routing, TanStack Query v5 for server state.
- **UI Component System**: shadcn/ui components on Radix UI, Tailwind CSS for styling, with a professional dark-mode primary aesthetic (Apple-style minimalist design with a neutral palette and single accent coral color).
- **State Management**: TanStack Query for server state, React Context for theme, react-hook-form with Zod for forms.
- **Routing**: Wouter with custom `useURLSearchParam` hook for URL query parameter synchronization.

### Backend (Hybrid Proxy + Python)
- **Express.js Proxy Server (Port 5000)**: TypeScript proxy forwarding `/api` requests to Python backend, handles automatic Python backend startup and serves static frontend in production.
- **Python/FastAPI Backend (Port 5001)**: FastAPI for async API routes, AsyncAnthropic client for non-blocking AI calls.
- **API Endpoints**: Includes endpoints for experts, categories, suggested questions, chat, auto-cloning, user profiles, insights, and persona management (CRUD for `personas` table).
- **Storage Layer**: In-memory Python storage (MemStorage) using Pydantic models for Expert, Conversation, and Message entities.

### AI Integration - Cognitive Cloning
- **Framework EXTRACT de 20 Pontos**: Each specialist uses a 20-point cognitive fidelity framework for ultra-realistic personalities, covering identity, experiences (story banks), reasoning patterns, terminology, axioms, contexts, techniques, limitations, meta-awareness, quotes, real cases, controversial takes, behavioral triggers, iconic callbacks, and trigger reactions.
- **Implementation Architecture**:
    - **Rich Python Classes**: Each clone is a class inheriting from `ExpertCloneBase` (e.g., `python_backend/clones/{name}.py`).
    - **CloneRegistry**: Auto-discovery system dynamically loads all clones from the `clones/` directory.
    - **LegendAgentFactory Integration**: Loads rich clones first, falling back to legacy text prompts if a rich clone is not found.
    - **Validation**: Minimum requirements (e.g., 3 story banks, 3 iconic callbacks, 5 triggers) are enforced.
    - **Claude API**: AsyncAnthropic (claude-sonnet-4-20250514) processes dynamic system prompts generated by `get_system_prompt()`.
- **Specialists**: 18 specialists with cross-referencing capabilities and Socratic questioning for diagnostic interactions.

### Key Architectural Decisions
- **Monorepo Structure**: `/client` (React), `/server` (Express), `/python_backend` (FastAPI), and `/shared` (TypeScript types).
- **Data Flow**: User interaction -> React UI -> TanStack Query -> Express proxy -> FastAPI -> Storage/AsyncAnthropic -> FastAPI -> Express -> React.
- **Development Workflow**: `npm run dev` starts Express, which spawns the auto-reloading Python backend.
- **UX/UI Decisions**: Apple-style minimalist design with a neutral color palette (95% grays, 1 accent coral), subtle animations (200-300ms, cubic-bezier), `font-semibold` for headings, and standardized rounded-2xl corners.
- **Multi-Category Navigation System**: 15 distinct categories with consistent neutral iconography and filtering capabilities.
- **Personalization System**: Expert recommendations based on user profiles, contextual AI prompt enrichment, Perplexity-powered suggested questions, business insights, and smart filters.

### Council Room - Real-Time SSE Streaming (November 5, 2025)

**âœ… Implementation Complete - Tasks 1-9**

AdvisorIA's premium feature: after initial multi-expert analysis, users enter a conversational "Council Room" where they can ask follow-up questions and receive real-time streaming responses from the council with full memory retention.

**Architecture:**
- **SSE Streaming Endpoint**: `GET /api/council/chat/{session_id}/stream?message={message}` - Server-Sent Events for real-time AI responses
- **Message Persistence**: PostgreSQL table `council_messages` stores user messages + assistant contributions (JSON array with expert attributions)
- **Event Types**: `user_message`, `expert_thinking`, `contribution` (expert name + content + order), `synthesizing`, `synthesis`, `complete`, `error`
- **Context Building**: Each follow-up includes: original analysis + full conversation history + new question for maximum continuity
- **Sequential Streaming**: Experts contribute in order (Expert 1 â†’ Expert 2 â†’ Expert 3 â†’ Synthesis), each visually attributed with badges + avatars

**Frontend (CouncilRoom.tsx):**
- **EventSource API**: Native browser SSE client consuming GET endpoint with query parameter
- **Visual Attribution**: Each expert contribution displays with avatar + name badge + coral accent border
- **ReactMarkdown Integration**: Markdown rendering with `remarkGfm` plugin for rich formatting (bold, bullets, code)
- **Synthesis Card**: Highlighted final consensus with border-primary/20 bg-primary/5 styling
- **Loading States**: "Expert pensando..." indicators during AI generation, disabled input during streaming
- **Responsive Layout**: Expert avatars at top, analysis summary card, scrollable chat area, persistent input at bottom

**Backend (FastAPI):**
- **SSE Response**: `StreamingResponse` with `text/event-stream` content-type, `async def event_generator()` yields sequential events
- **CouncilOrchestrator Integration**: Reuses existing `_get_expert_analysis()` and `_synthesize_consensus()` methods
- **Full Memory**: Loads `CouncilAnalysis` (original analysis) + `CouncilMessage[]` (chat history) before processing new question
- **Contribution Serialization**: Pydantic `StreamContribution` model with `.model_dump()` for JSON serialization in SSE data

**Database Schema (shared/schema.ts):**
```typescript
council_messages: {
  id: varchar (UUID),
  sessionId: varchar (FK to council_analyses),
  role: varchar ('user' | 'assistant'),
  content: text,
  contributions: json (optional - [{expertName, content, order}] for assistant messages),
  createdAt: timestamp
}
```

**UX Flow:**
1. User completes initial council analysis (2-5 experts selected)
2. "Entrar na Sala do Conselho" button transitions to `/council-room/:sessionId`
3. Page loads: displays expert avatars, analysis summary, empty chat history
4. User types follow-up question â†’ sends â†’ input disables
5. SSE stream begins: sequential expert contributions appear with visual attribution
6. Synthesis card appears at end with consensus decision
7. Input re-enables â†’ user can ask unlimited follow-ups with full memory retention

**Technical Decisions:**
- **GET vs POST**: SSE requires GET (EventSource API limitation), message passed as query parameter
- **Sequential vs Parallel**: Sequential streaming (one expert at a time) for clearer attribution and better UX
- **Memory Strategy**: Load full history on every request (simple, reliable) vs incremental updates (complex, error-prone)
- **Persistence Timing**: Save assistant message AFTER synthesis complete (ensures atomic save of contributions + synthesis)

**Testing:**
- âœ… E2E playwright validation: analysis â†’ council room transition, SSE streaming works, contributions persist, GET /messages returns correctly
- âœ… Manual curl tests: endpoint responds to EventSource GET requests, returns proper SSE format
- âœ… Backend logging: extensive `[SSE]` prefixed logs for debugging event generator flow

**Next Steps:**
- ðŸ”„ Tools Integration (Tasks 10-14): YouTube Research, Trend Analysis, News Monitoring via Perplexity
- ðŸ”„ Polish & Animations (Tasks 15-17): Avatar highlights, smooth transitions, final E2E Disney-level validation

## External Dependencies

- **Anthropic Claude API**: AI model interactions and cognitive cloning.
- **Perplexity API**: Research for auto-cloning feature and content generation.
- **React**: Frontend library.
- **Vite**: Build tool.
- **Wouter**: Client-side router.
- **TanStack Query**: Server state management.
- **shadcn/ui & Radix UI**: UI component libraries.
- **Tailwind CSS**: Styling framework.
- **Express.js**: Proxy server.
- **FastAPI**: Python backend framework.
- **AsyncAnthropic**: Asynchronous Python client for Anthropic API.
- **Uvicorn**: ASGI server for FastAPI.
- **Pydantic**: Data validation for Python models.
- **Zod**: Schema declaration and validation for TypeScript.
- **Framer Motion**: Animation library for React.
- **PostgreSQL**: Database for storing persona data.

## Cognitive Clone Migration Status

### âœ… Migration Complete (November 4, 2025)

**18/18 Clones Migrated to Rich Python Classes**

All marketing legends successfully migrated from text prompts to rich Python classes implementing the Framework EXTRACT de 20 Pontos:

1. âœ… Seth Godin - Purple Cow, Tribes, Permission Marketing
2. âœ… Philip Kotler - 4Ps, STP Framework, Marketing 3.0
3. âœ… David Ogilvy - Rolls-Royce headline, Consumer respect, Long copy
4. âœ… Gary Vaynerchuk - Day Trading Attention, Document Don't Create
5. âœ… Eugene Schwartz - Breakthrough Advertising, 5 Awareness Stages
6. âœ… Claude Hopkins - Scientific Advertising, Pepsodent campaign
7. âœ… Jay Abraham - 3 Ways to Grow, $9.4B Man, Parthenon Principles
8. âœ… Dan Kennedy - Magnetic Marketing, No BS, Time Vampires
9. âœ… Al Ries - Positioning, 22 Immutable Laws, First in Mind
10. âœ… Robert Cialdini - 6 Principles of Influence, Reciprocity
11. âœ… Donald Miller - StoryBrand SB7, Hero's Journey Marketing
12. âœ… Neil Patel - SEO + Content, Long-Form Wins, 3M+ monthly visits
13. âœ… David Aaker - Brand Equity Model, 5 Components Framework
14. âœ… Jay Levinson - Guerrilla Marketing, 200 Weapons, 21M+ copies sold
15. âœ… Ann Handley - Content Quality, Everybody Writes, Do Less and Obsess
16. âœ… Simon Sinek - Start With Why, Golden Circle, Think Different
17. âœ… Daniel Kahneman - Behavioral Economics, System 1/2, Nobel Prize 2002
18. âœ… Drayton Bird - Direct Response, Ogilvy ProtÃ©gÃ©, Â£1.5M campaigns

**Quality Standards Achieved (RIGOR TOTAL - November 4, 2025):**
- âœ… 5+ story banks com mÃ©tricas reais por clone (90 total story banks)
- âœ… 7+ iconic callbacks Ãºnicos por clone (126+ total)
- âœ… 15+ positive triggers por clone (270+ total)
- âœ… 15+ negative triggers por clone (270+ total)
- âœ… 5+ trigger reactions especÃ­ficas por clone (90+ total)
- âœ… 350+ linhas de system prompt por clone (6,300+ total)
- âœ… Framework EXTRACT de 20 pontos implementado completamente
- âœ… CloneRegistry validation: "18 clones registered, cada um com 5 stories"
- âœ… Zero fallbacks para legacy text prompts
- âœ… Testes comportamentais automatizados: 18/18 clones PASSED
- âœ… ConsolidaÃ§Ã£o de boilerplate: ~289 linhas de cÃ³digo duplicado eliminadas

**Technical Implementation:**
- Location: `python_backend/clones/*.py`
- Base Class: `ExpertCloneBase` (abstract class com Framework EXTRACT, auto-initialization)
- Registry: `CloneRegistry` auto-discovery system
- Validation: Minimum 5 stories, 7 callbacks, 15 positive triggers, 15 negative triggers enforced
- Testing: `python_backend/tests/test_clones_behavioral.py` (automated behavioral validation)
- Integration: `LegendAgentFactory` loads rich clones first
- API: Claude Sonnet 4 (claude-sonnet-4-20250514) via AsyncAnthropic

**Code Quality Improvements (November 4, 2025):**
- âœ… Consolidada lÃ³gica de inicializaÃ§Ã£o no `ExpertCloneBase.__init__`
- âœ… Auto-population de story_banks, callbacks, triggers via `get_*()` methods
- âœ… Eliminadas ~289 linhas de boilerplate duplicado em 17 clones
- âœ… Cada clone __init__ agora tem ~15-17 linhas (antes: ~30-35 linhas)
- âœ… Validation atualizada para exigir 15+/15+ triggers (rigor total)

**Avatar Generation Status (November 5, 2025):**
- âœ… **14/18 Experts com Avatares Profissionais**
  - 9 novos avatares gerados: Eugene Schwartz, Jay Abraham, Jay Levinson, Robert Cialdini, David Aaker, Daniel Kahneman, Donald Miller, Drayton Bird, Simon Sinek
  - 5 avatares prÃ©-existentes: Philip Kotler, David Ogilvy, Claude Hopkins, Seth Godin, Gary Vaynerchuk
  - 4 experts sem avatares: Al Ries & Jack Trout (dupla), Dan Kennedy, Ann Handley, Neil Patel
- âœ… Todos os avatares armazenados em `/attached_assets/generated_images/`
- âœ… Backend validado: API `/api/experts` retorna 14/18 avatars corretamente

**Next Steps:**
- âœ… Legacy prompts preserved em `python_backend/prompts/legends.py` (backup)
- âœ… Rigor Total atingido: 15+/15+ triggers em TODOS os 18 clones
- âœ… Testes comportamentais automatizados implementados e validados
- âœ… E2E Validation 100% PASS: 18 experts visÃ­veis na UI, triggers funcionando
- âœ… Avatares gerados e integrados com sucesso (14/18 experts)
- ðŸ”„ Consider deprecating legacy fallback apÃ³s validaÃ§Ã£o completa de produÃ§Ã£o
- ðŸ”„ Deduplicate trigger keywords para maximizar cobertura semÃ¢ntica
- ðŸ”„ Spot-audit trigger reactions com vocabulÃ¡rio expandido
- ðŸ”„ Documentar thresholds em contributor guidelines para futuros clones
- ðŸ”„ Auto-generation template for future clones
- ðŸ”„ Gerar avatares para os 4 experts restantes (opcional)